name: Post scheduler

on:
  schedule:
    # Runs every 5 minutes. GitHub may delay a few minutes â€” the scheduler
    # looks back 6 minutes to catch any posts due in that window.
    - cron: '*/5 * * * *'
  workflow_dispatch:
    # Allows manual trigger from the Actions tab for testing

concurrency:
  group: post-scheduler
  cancel-in-progress: false  # Never cancel a run mid-post

permissions:
  contents: write  # Needed to commit updated schedule/history files

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run scheduler
        env:
          # Direct API credentials (platform adapters)
          TWITTER_API_KEY:       ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET:    ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN:  ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          BLUESKY_HANDLE:        ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD:  ${{ secrets.BLUESKY_APP_PASSWORD }}
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_PERSON_ID:    ${{ secrets.LINKEDIN_PERSON_ID }}
          FACEBOOK_PAGE_ID:      ${{ secrets.FACEBOOK_PAGE_ID }}
          FACEBOOK_PAGE_TOKEN:   ${{ secrets.FACEBOOK_PAGE_TOKEN }}
          INSTAGRAM_BUSINESS_ID: ${{ secrets.INSTAGRAM_BUSINESS_ID }}
          TIKTOK_ACCESS_TOKEN:   ${{ secrets.TIKTOK_ACCESS_TOKEN }}
          # Zapier webhook fallbacks (used when direct API creds are absent)
          ZAPIER_WEBHOOK_TWITTER:   ${{ secrets.ZAPIER_WEBHOOK_TWITTER }}
          ZAPIER_WEBHOOK_LINKEDIN:  ${{ secrets.ZAPIER_WEBHOOK_LINKEDIN }}
          ZAPIER_WEBHOOK_FACEBOOK:  ${{ secrets.ZAPIER_WEBHOOK_FACEBOOK }}
          ZAPIER_WEBHOOK_INSTAGRAM: ${{ secrets.ZAPIER_WEBHOOK_INSTAGRAM }}
          ZAPIER_WEBHOOK_TIKTOK:    ${{ secrets.ZAPIER_WEBHOOK_TIKTOK }}
          ZAPIER_WEBHOOK_BLUESKY:   ${{ secrets.ZAPIER_WEBHOOK_BLUESKY }}
        run: python scripts/run-scheduler.py

      - name: Commit updated data files
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/schedule.json data/history.json
          git diff --staged --quiet || git commit -m "Update post schedule [skip ci]"
          git push
